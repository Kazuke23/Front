name: Deploy Angular to S3

on:
  push:
    branches:
      - main   #v20

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build Angular
        run: npx ng build --configuration production

      - name: DEBUG - Check what was built
        run: |
          echo "=== ¬øEXISTE DIST? ==="
          ls -la | grep dist
          echo "=== ESTRUCTURA COMPLETA DE DIST ==="
          if [ -d "dist" ]; then
            find dist -type f | head -20
            echo "=== CONTENIDO DE INDEX.HTML ==="
            find dist -name "index.html" -exec cat {} \;
          else
            echo "‚ùå ERROR: NO EXISTE DIRECTORIO DIST"
            echo "=== ESTRUCTURA ACTUAL ==="
            ls -la
          fi

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: DEBUG - Check S3 bucket before deploy
        run: |
          echo "=== CONTENIDO ACTUAL DEL BUCKET S3 ==="
          aws s3 ls s3://${{ secrets.S3_BUCKET_NAME }} --recursive || echo "‚ùå No se puede acceder al bucket"

      - name: Deploy with verification
        run: |
          echo "üöÄ INICIANDO DESPLIEGUE..."
          if [ -d "dist" ]; then
            echo "üìÅ Desplegando desde: dist/"
            aws s3 sync dist/ s3://${{ secrets.S3_BUCKET_NAME }} --delete
            echo "‚úÖ Sync completado"
          else
            echo "‚ùå ERROR: No existe dist/"
            exit 1
          fi

      - name: DEBUG - Check S3 bucket after deploy
        run: |
          echo "=== CONTENIDO DEL BUCKET DESPU√âS DEL DESPLIEGUE ==="
          aws s3 ls s3://${{ secrets.S3_BUCKET_NAME }} --recursive --human-readable
